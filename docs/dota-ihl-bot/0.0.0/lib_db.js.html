<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>lib/db.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="CommendCommand.html">CommendCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="GameModeCommand.html">GameModeCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LeaderboardCommand.html">LeaderboardCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LeagueCreateCommand.html">LeagueCreateCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LeagueInfoCommand.html">LeagueInfoCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LeagueSeasonCommand.html">LeagueSeasonCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LeagueUpdateCommand.html">LeagueUpdateCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LobbyCreateCommand.html">LobbyCreateCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LobbyFirstPickCommand.html">LobbyFirstPickCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LobbyGameModeCommand.html">LobbyGameModeCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LobbyInviteCommand.html">LobbyInviteCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LobbyKickCommand.html">LobbyKickCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LobbyKillCommand.html">LobbyKillCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LobbyStartCommand.html">LobbyStartCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="LobbySwapCommand.html">LobbySwapCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-dotaBot-DotaBot.html">DotaBot</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-dotaBot-DotaBot.html#connect">connect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-dotaBot-DotaBot.html#disconnect">disconnect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-dotaBot-DotaBot.html#schedule">schedule</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html">IHLManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#attachEventHandlers">attachEventHandlers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#attachMessageHandlers">attachMessageHandlers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#banInhouseQueue">banInhouseQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#checkInhouseQueue">checkInhouseQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#createNewLeague">createNewLeague</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#createNewLobbyForInhouse">createNewLobbyForInhouse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#joinInhouseQueue">joinInhouseQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#leaveInhouseQueue">leaveInhouseQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#onDraftMember">onDraftMember</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#onLobbyKill">onLobbyKill</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#onLobbyReady">onLobbyReady</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#onLobbyTimedOut">onLobbyTimedOut</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#onMatchEnd">onMatchEnd</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#onPlayerReady">onPlayerReady</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#onPlayersReady">onPlayersReady</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#processEventQueue">processEventQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#queueEvent">queueEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#registerLobbyTimeout">registerLobbyTimeout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#runLobby">runLobby</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager-IHLManager.html#unregisterLobbyTimeout">unregisterLobbyTimeout</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-matchTracker-MatchTracker.html">MatchTracker</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-matchTracker-MatchTracker.html#run">run</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-matchTracker-MatchTracker.html#start">start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-matchTracker-MatchTracker.html#stop">stop</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="NicknameCommand.html">NicknameCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PickCommand.html">PickCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Queue.html">Queue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Queue.html#block">block</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Queue.html#clear">clear</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Queue.html#release">release</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Queue.html#schedule">schedule</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="QueueBanCommand.html">QueueBanCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="QueueClearCommand.html">QueueClearCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="QueueJoinCommand.html">QueueJoinCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="QueueLeaveCommand.html">QueueLeaveCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="QueueReadyCommand.html">QueueReadyCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="QueueStatusCommand.html">QueueStatusCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="RegisterCommand.html">RegisterCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="RepCommand.html">RepCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="RolesCommand.html">RolesCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="UnrepCommand.html">UnrepCommand</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WhoisCommand.html">WhoisCommand</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-client.html">client</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-constants.html">constants</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-db.html">db</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-dotaBot.html">dotaBot</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-dotaBot.html#~isDotaLobbyReady">isDotaLobbyReady</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-dotaBot.html#~slotToFaction">slotToFaction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-dotaBot.html#~updatePlayerState">updatePlayerState</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-guild.html">guild</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ihl.html">ihl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~addLobbyToInhouse">addLobbyToInhouse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~banInhouseQueue">banInhouseQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~checkInhouseQueue">checkInhouseQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~createInhouseState">createInhouseState</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~createNewLobbyForInhouse">createNewLobbyForInhouse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~getUserRankTier">getUserRankTier</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~joinInhouseQueue">joinInhouseQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~leaveInhouseQueue">leaveInhouseQueue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~loadLobbiesIntoInhouse">loadLobbiesIntoInhouse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~registerUser">registerUser</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~removeLobbyFromInhouse">removeLobbyFromInhouse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihl.html#~runLobbiesForInhouse">runLobbiesForInhouse</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ihlManager.html">ihlManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~addInhouseState">addInhouseState</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~findUser">findUser</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~getIndexOfInhouseState">getIndexOfInhouseState</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~getInhouseState">getInhouseState</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~getLobbyByChannelId">getLobbyByChannelId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~getLobbyByLobbyName">getLobbyByLobbyName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~getLobbyFromMessage">getLobbyFromMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~isMessageFromAdmin">isMessageFromAdmin</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~loadInhouseState">loadInhouseState</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~loadInhouseStates">loadInhouseStates</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~loadInhouseStatesFromLeagues">loadInhouseStatesFromLeagues</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ihlManager.html#~transformLeagueGuild">transformLeagueGuild</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-lobby.html">lobby</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-matchTracker.html">matchTracker</a></span></li><li class="nav-heading">Externals</li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-CategoryChannel.html">CategoryChannel</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-Client.html">Client</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-Command.html">Command</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-EventEmitter.html">EventEmitter</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-Guild.html">Guild</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-GuildChannel.html">GuildChannel</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-GuildMember.html">GuildMember</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-Message.html">Message</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-Model.html">Model</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-Role.html">Role</a></span></li><li class="nav-heading"><span class="nav-item-type type-external">E</span><span class="nav-item-name"><a href="external-User.html">User</a></span></li><li class="nav-heading">Events</li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="module-ihlManager.html#~event:EVENT_MATCH_ENDED">EVENT_MATCH_ENDED</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="module-ihlManager.html#~event:EVENT_PICK_PLAYER">EVENT_PICK_PLAYER</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="module-ihlManager.html#~event:EVENT_PLAYER_READY">EVENT_PLAYER_READY</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="module-ihlManager.html#~event:EVENT_PLAYERS_READY">EVENT_PLAYERS_READY</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/db.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module db
 */
 
 /**
 * Sequelize Model object
 * @external Model
 * @see {@link http://docs.sequelizejs.com/class/lib/model.js~Model.html}
 */
 
/**
 * @typedef module:db.League
 * @type {external:Model}
 */
 
/**
 * @typedef module:db.User
 * @type {external:Model}
 */
 
const Sequelize = require('sequelize');
const db = require('../models');
const CONSTANTS = require('./constants');

const Op = Sequelize.Op;

const findAllLeagues = async () => db.League.findAll();

const findAllActiveLobbies = async guild_id => db.Lobby.scope('active', { method: ['guild', guild_id] }).findAll();

const findAllInProgressLobbies = async () => db.Lobby.findAll({ where: { state: CONSTANTS.STATE_MATCH_IN_PROGRESS } });

const findLeague = async guild_id => db.League.find({ where: { guild_id } });

const findOrCreateLeague = async guild_id => db.sequelize.transaction(async t => db.League.findOrCreate({
    where: { guild_id },
    transaction: t,
})
    .spread(league => db.Season.findOrCreate({
        where: { league_id: league.id, active: true },
        include: [db.League],
        transaction: t,
    }))
    .spread(season => season.getLeague()
        .then(league => league.update({ current_season_id: season.id }, { transaction: t }))));

const createSeason = async guild_id => sequelize.transaction(async (t) => {
    const league = await findLeague(guild_id);
    await db.Season.update({ active: false }, { where: { league_id: league.id }, transaction: t });
    const season = await db.Season.create({ league_id: league.id, active: true }, { transaction: t });
    await league.update({ current_season_id: season.id }, { transaction: t });
    return season;
});

const findOrCreateBot = async (league, steamid_64, steam_name, steam_user, steam_pass) => db.Bot.findOrCreate({
    where: {
        league_id: league.id,
        steamid_64,
        steam_name,
        steam_user,
        steam_pass,
    },
})
    .spread(bot => bot);

const findOrCreateLobby = async (league, lobby_name) => db.Lobby.findOrCreate({
    where: { league_id: league.id, season_id: league.current_season_id, lobby_name },
    include: [{
        model: db.League,
        where: {
            id: league.id,
        },
    }],
})
    .spread(lobby => lobby);

const findOrCreateLobbyForGuild = async (guild_id, lobby_name) => findOrCreateLobby(await findOrCreateLeague(guild_id), lobby_name);

const findLobby = async lobby_name => db.Lobby.scope({ method: ['lobby_name', lobby_name] }).find();

const findBot = async id => db.Bot.findOne({ where: { id } });

const findAllUnassignedBot = async () => db.Bot.findAll({ where: { status: CONSTANTS.BOT_OFFLINE }, include: [{ model: db.Lobby, where: { active: true, state: { [Op.ne]: CONSTANTS.STATE_MATCH_ENDED } }, required: false }] });

const findUserByDiscordId = guild_id => async discord_id => db.User.scope({ method: ['guild', guild_id] }, { method: ['discord_id', discord_id] }).find();

const findUserBySteamId64 = guild_id => async steamid_64 => db.User.scope({ method: ['guild', guild_id] }, { method: ['steamid_64', steamid_64] }).find();

const findUserByNicknameLevenshtein = member => db.sequelize.query('SELECT * FROM "Users" WHERE levenshtein(LOWER(nickname), LOWER(:nickname)) &lt; 2', { replacements: { nickname: member }, model: db.User });

const findOrCreateUser = async (league, steamid_64, discord_id, rank_tier) => db.User.findOrCreate({
    where: {
        league_id: league.id, steamid_64, discord_id, rank_tier,
    },
    include: [{
        model: db.League,
        where: {
            id: league.id,
        },
    }],
})
    .spread(user => user);

const findOrCreateQueue = async user => db.Queue.findOrCreate({
    where: { league_id: user.league_id, user_id: user.id },
    include: [{
        model: db.User,
        where: {
            id: user.id,
        },
    }],
});

const findOrCreateMatch = async match_id => db.Match.findOrCreate({
    where: {
        match_id,
    },
    defaults: {
        match_id,
    },
});

const findMatch = async match_id => db.Match.findOne({ where: { match_id }, include: [db.Lobby] });

const queryUserLeaderboardRank = league_id => season_id => async user_id => db.sequelize.query('SELECT rank FROM (SELECT *, rank() OVER (ORDER BY rating DESC) FROM "Leaderboards" WHERE league_id = :league_id AND season_id = :season_id) AS ranking WHERE user_id = :user_id LIMIT 1',
    { replacements: { league_id, season_id, user_id }, type: db.sequelize.QueryTypes.SELECT }).then(([rank]) => (rank ? rank.rank : null));

const queryLeaderboardRank = league_id => season_id => async limit => db.sequelize.query('SELECT * FROM (SELECT *, rank() OVER (ORDER BY rating DESC) FROM "Leaderboards" WHERE league_id = :league_id AND season_id = :season_id LIMIT :limit) AS ranking INNER JOIN "Users" as users ON ranking.user_id = users.id',
    { replacements: { league_id, season_id, limit }, type: db.sequelize.QueryTypes.SELECT });


const updateLeague = guild_id => async values => db.League.update(values, { where: { guild_id } });

const updateLobbyState = async lobbyOrState => db.Lobby.update(lobbyOrState, { where: { lobby_name: lobbyOrState.lobby_name } });

const updateBotStatusBySteamId = status => async steamid_64 => db.Bot.update({ status }, { where: { steamid_64 } });

const updateBotStatus = status => async id => db.Bot.update({ status }, { where: { id } });

const findInQueueWithUser = async () => db.Queue.findAll({
    where: { state: CONSTANTS.QUEUE_IN_QUEUE }, limit: 10, order: [['timestamp', 'ASC']], include: [db.User],
});

const findAllInQueueWithUser = async () => db.Queue.findAll({
    where: { state: CONSTANTS.QUEUE_IN_QUEUE }, order: [['timestamp', 'ASC']], include: [db.User],
});

const findInQueueBySteamId = guild_id => async steamid_64 => db.Queue.scope({ method: ['state', CONSTANTS.QUEUE_IN_QUEUE] }, { method: ['guild', guild_id] }, { method: ['steamid_64', steamid_64] }).findOne();

const updateQueueStates = state => async ids => db.Queue.update({ state }, { where: { id: { [Op.in]: ids } } });

const updateQueueStatesByUserId = state => async user_ids => db.Queue.update({ state }, { where: { user_id: { [Op.in]: user_ids } } });

const destroyQueues = async ids => db.Queue.destroy({ where: { id: { [Op.in]: ids } } });

const destroyQueuesByGuildId = async (guild_id) => {
    const queues = await db.Queue.scope({ method: ['guild', guild_id] }).findAll();
    return await destroyQueues(queues.map(queue => queue.id));
};

const destroyQueuesByUserId = async user_ids => db.Queue.destroy({ where: { user_id: { [Op.in]: user_ids } } });

const countQueueInQueue = async guild_id => db.Queue.scope({ method: ['state', CONSTANTS.QUEUE_IN_QUEUE] }, { method: ['guild', guild_id] }).count();

const findOrCreateReputation = league => giver => async receiver => db.Reputation.findOrCreate({ where: { recipient_user_id: receiver.id, giver_user_id: giver.id }, defaults: { timestamp: Date.now(), season_id: league.current_season_id } });

const destroyReputation = league => giver => async receiver => db.Reputation.destroy({ where: { recipient_user_id: receiver.id, giver_user_id: giver.id, season_id: league.current_season_id } });

module.exports = {
    findAllLeagues,
    findAllActiveLobbies,
    findAllInProgressLobbies,
    findLeague,
    findOrCreateLeague,
    createSeason,
    findOrCreateBot,
    findOrCreateLobby,
    findOrCreateLobbyForGuild,
    findLobby,
    findBot,
    findAllUnassignedBot,
    findOrCreateUser,
    findOrCreateQueue,
    findOrCreateMatch,
    findMatch,
    findUserByDiscordId,
    findUserBySteamId64,
    findUserByNicknameLevenshtein,
    queryUserLeaderboardRank,
    queryLeaderboardRank,
    updateLeague,
    updateLobbyState,
    updateBotStatusBySteamId,
    updateBotStatus,
    findInQueueWithUser,
    findAllInQueueWithUser,
    findInQueueBySteamId,
    updateQueueStates,
    updateQueueStatesByUserId,
    destroyQueues,
    destroyQueuesByGuildId,
    destroyQueuesByUserId,
    countQueueInQueue,
    findOrCreateReputation,
    destroyReputation,
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Jul 19 2018 14:25:59 GMT+0000 (UTC) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
